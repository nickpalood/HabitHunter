<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Graphs & Stats - Habit Hunter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='graphs.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-brand">
            <div class="navbar-avatar">{{ session.username[0].upper() if session.username else 'U' }}</div>
            <strong>Habit Hunter</strong>
        </div>
        <div class="navbar-timeframe">
            <label for="timeframe" style="margin-right: 8px; font-size: 14px; color: #666;">Timeframe:</label>
            <select id="timeframe" onchange="changeTimeframe(this.value)" style="padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; background: white; cursor: pointer;">
                <option value="1" {% if timeframe_months == 1 %}selected{% endif %}>1 Month</option>
                <option value="2" {% if timeframe_months == 2 %}selected{% endif %}>2 Months</option>
                <option value="3" {% if timeframe_months == 3 %}selected{% endif %}>3 Months</option>
                <option value="6" {% if timeframe_months == 6 %}selected{% endif %}>6 Months</option>
                <option value="9" {% if timeframe_months == 9 %}selected{% endif %}>9 Months</option>
                <option value="12" {% if timeframe_months == 12 %}selected{% endif %}>12 Months</option>
            </select>
        </div>
        <div class="navbar-nav">
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('income') }}">Income</a>
            <a href="{{ url_for('expenses') }}">Expenses</a>
            <a href="{{ url_for('budgets') }}">Budgets</a>
            <a href="{{ url_for('reports') }}">Reports</a>
            <a href="{{ url_for('graphs_stats') }}" class="active">Graphs & Stats</a>
            <a href="{{ url_for('revolut_import') }}">Revolut Import</a>
            <a href="{{ url_for('logout') }}" style="margin-left: auto;">Logout ({{ session.username }})</a>
        </div>
    </div>

    <script>
    function changeTimeframe(months) {
        fetch('/set_timeframe/' + months, { method: 'POST' })
            .then(() => window.location.reload());
    }
    </script>

    <div class="container container-lg">
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="flash-messages">
            {% for message in messages %}
              <div class="alert alert-success">{{ message }}</div>
            {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1>üìä Analytics & Insights</h1>

            </div>
        </div>

        <!-- Quick Stats Section -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üí∞</div>
                <div class="stat-content">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value">‚Ç¨{{ "%.2f"|format(total_income) }}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üí∏</div>
                <div class="stat-content">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value">‚Ç¨{{ "%.2f"|format(total_expenses) }}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">üìà</div>
                <div class="stat-content">
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value" style="color: {% if balance >= 0 %}#10b981{% else %}#ef4444{% endif %};">‚Ç¨{{ "%.2f"|format(balance) }}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">üìä</div>
                <div class="stat-content">
                    <div class="stat-label">Avg Transaction</div>
                    <div class="stat-value">‚Ç¨{{ "%.2f"|format(avg_expense) }}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">üéØ</div>
                <div class="stat-content">
                    <div class="stat-label">Max Expense</div>
                    <div class="stat-value">‚Ç¨{{ "%.2f"|format(max_expense) }}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">‚è±Ô∏è</div>
                <div class="stat-content">
                    <div class="stat-label">Busiest Day</div>
                    <div class="stat-value" style="font-size: 1rem;">{{ busiest_day }}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%);">üåô</div>
                <div class="stat-content">
                    <div class="stat-label">Avg Daily Spend</div>
                    <div class="stat-value">‚Ç¨{{ "%.2f"|format(avg_daily_spend) }}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #1fa2ff 0%, #12d8fa 100%);">üíé</div>
                <div class="stat-content">
                    <div class="stat-label">Min Expense</div>
                    <div class="stat-value">‚Ç¨{{ "%.2f"|format(min_expense) }}</div>
                </div>
            </div>
        </div>

        <!-- PREDICTIONS & FORECASTING SECTION -->
        <div style="margin: 3rem 0;">
            <h2 style="font-size: 2rem; margin-bottom: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Future Predictions & Forecasts</h2>
            
            <div class="predictions-grid">
                <!-- Next Month Prediction -->
                <div class="prediction-card">
                    <div class="prediction-content">
                        <h3>Next Month's Spending</h3>
                        <div class="prediction-value">‚Ç¨{{ "%.2f"|format(predicted_monthly_expense) }}</div>
                        <p class="prediction-desc">Based on your spending history, you'll likely spend this amount next month</p>
                    </div>
                </div>

                <!-- Yearly Balance Prediction -->
                <div class="prediction-card">
                    <div class="prediction-content">
                        <h3>Predicted Balance (1 Year)</h3>
                        <div class="prediction-value" style="color: {% if predicted_yearly_balance >= balance %}#10b981{% else %}#ef4444{% endif %};">‚Ç¨{{ "%.2f"|format(predicted_yearly_balance) }}</div>
                        <p class="prediction-desc">Your estimated balance in 12 months if spending continues</p>
                    </div>
                </div>

                <!-- Days Until Low Balance -->
                <div class="prediction-card">
                    <div class="prediction-content">
                        <h3>Days Until Balance Depletes</h3>
                        <div class="prediction-value">{% if days_until_low > 100000 or days_until_low < 0 %}‚àû{% else %}{{ "%.0f"|format(days_until_low) }}{% endif %} days</div>
                        <p class="prediction-desc">At current spending rate, you'll run out of funds in</p>
                    </div>
                </div>

                <!-- Projected Annual Spending -->
                <div class="prediction-card">
                    <div class="prediction-content">
                        <h3>Projected Annual Spending</h3>
                        <div class="prediction-value">‚Ç¨{{ "%.2f"|format(predicted_monthly_expense * 12) }}</div>
                        <p class="prediction-desc">Estimated total expenses for the next 12 months</p>
                    </div>
                </div>
            </div>

            <!-- Next 3 Months Detail -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h3>Next 3 Months Forecast</h3>
                    <p class="chart-subtitle">Predicted monthly spending for the next quarter</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; padding: 2rem;">
                    {% for prediction in next_3_months_predictions %}
                    <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 0.75rem; border: 1px solid #e5e7eb;">
                        <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">Month {{ loop.index }}</div>
                        <div style="font-size: 1.75rem; font-weight: bold; color: #667eea;">‚Ç¨{{ "%.2f"|format(prediction) }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Top Categories Predictions (Next Year) -->
            {% if top_pred_categories %}
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h3>Top Spending Categories (Next Year Forecast)</h3>
                    <p class="chart-subtitle">Predicted yearly spending per category</p>
                </div>
                <div style="padding: 2rem;">
                    {% for category, prediction in top_pred_categories.items() %}
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600; color: #1f2937;">{{ category }}</span>
                            <span style="color: #667eea; font-weight: 700;">‚Ç¨{{ "%.2f"|format(prediction) }}</span>
                        </div>
                        <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: {{ (prediction / (max_pred_category_value or 1) * 100) }}%;"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Prediction Insights -->
            <div style="margin-top: 2rem; padding: 2rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 1rem; border-left: 4px solid #f59e0b;">
                <h3 style="margin-top: 0; color: #92400e;">Insights from Predictions</h3>
                <ul style="color: #78350f; margin: 1rem 0; padding-left: 2rem;">
                    {% if predicted_yearly_balance < balance %}
                    <li>Your balance is predicted to <strong>decrease</strong> over the next year. Consider reducing expenses or increasing income.</li>
                    {% elif predicted_yearly_balance > balance * 2 %}
                    <li>Excellent! Your balance is predicted to <strong>increase significantly</strong> over the next year.</li>
                    {% else %}
                    <li>Your balance should remain relatively <strong>stable</strong> based on current trends.</li>
                    {% endif %}
                    
                    {% if predicted_monthly_expense > avg_expense * 1.2 %}
                    <li>Your spending is trending <strong>upward</strong>. Monitor your expenses to avoid overspending.</li>
                    {% elif predicted_monthly_expense < avg_expense * 0.8 %}
                    <li>Your spending shows a <strong>downward trend</strong>. Keep up the good work!</li>
                    {% endif %}
                    
                    {% if top_pred_categories %}
                        {% set top_cat = top_pred_categories.keys() | list | first %}
                        <li><strong>{{ top_cat }}</strong> is your biggest spending category for the next year. This is worth monitoring.</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            
            <!-- 1. Spending by Category (Bar Chart) -->
            {% if category_labels %}
            <div class="card chart-card">
                <div class="card-header">
                    <h3>Spending by Category</h3>
                    <p class="chart-subtitle">Total breakdown of your expenses</p>
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            {% endif %}

            <!-- 2. Top Categories Pie -->
            {% if top_cat_names %}
            <div class="card chart-card">
                <div class="card-header">
                    <h3>Top 5 Categories</h3>
                    <p class="chart-subtitle">Your biggest spending areas</p>
                </div>
                <div class="chart-container">
                    <canvas id="topCategoriesChart"></canvas>
                </div>
            </div>
            {% endif %}

            <!-- 3. Spending by Day of Week -->
            {% if day_labels %}
            <div class="card chart-card">
                <div class="card-header">
                    <h3>Spending by Day of Week</h3>
                    <p class="chart-subtitle">Which days do you spend the most?</p>
                </div>
                <div class="chart-container">
                    <canvas id="dayChart"></canvas>
                </div>
            </div>
            {% endif %}

            <!-- 4. Transaction Frequency by Day -->
            {% if day_transaction_counts %}
            <div class="card chart-card">
                <div class="card-header">
                    <h3>Transaction Frequency</h3>
                    <p class="chart-subtitle">How many transactions per day?</p>
                </div>
                <div class="chart-container">
                    <canvas id="frequencyChart"></canvas>
                </div>
            </div>
            {% endif %}

            <!-- 5. Monthly Trend (Income vs Expenses) -->
            {% if month_labels %}
            <div class="card chart-card full-width">
                <div class="card-header">
                    <h3>Monthly Trends</h3>
                    <p class="chart-subtitle">Income and expense trends over time</p>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            {% endif %}

            <!-- 6. Spending Throughout the Month -->
            {% if date_labels %}
            <div class="card chart-card full-width">
                <div class="card-header">
                    <h3>Cumulative Monthly Spending</h3>
                    <p class="chart-subtitle">How your spending distributes across the month</p>
                </div>
                <div class="chart-container">
                    <canvas id="dateChart"></canvas>
                </div>
            </div>
            {% endif %}

            <!-- 7. Category Breakdown Table -->
            {% if expense_percentages %}
            <div class="card chart-card full-width">
                <div class="card-header">
                    <h3>Category Breakdown</h3>
                    <p class="chart-subtitle">Percentage of total spending per category</p>
                </div>
                <div class="category-table">
                    {% for category, percentage in expense_percentages.items() | sort %}
                    <div class="category-row">
                        <div class="category-name">{{ category }}</div>
                        <div class="category-bar">
                            <div class="category-fill" style="width: {{ percentage }}%; background: linear-gradient(90deg, #a855f7 0%, #ec4899 100%);"></div>
                        </div>
                        <div class="category-percent">{{ "%.1f"|format(percentage) }}%</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

    </div>

    <script>
        const colors = [
            '#a855f7', '#ef4444', '#f59e0b', '#10b981', '#3b82f6',
            '#ec4899', '#06b6d4', '#8b5cf6', '#f97316', '#14b8a6'
        ];

        // 1. Spending by Category (Bar Chart)
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: {{ category_labels|tojson }},
                    datasets: [{
                        label: 'Total Spending (‚Ç¨)',
                        data: {{ category_values|tojson }},
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 2. Top Categories (Pie Chart)
        const topCatCtx = document.getElementById('topCategoriesChart');
        if (topCatCtx) {
            new Chart(topCatCtx, {
                type: 'doughnut',
                data: {
                    labels: {{ top_cat_names|tojson }},
                    datasets: [{
                        data: {{ top_cat_values|tojson }},
                        backgroundColor: colors.slice(0, {{ top_cat_names|length }}),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }

        // 3. Day of Week (Area Chart)
        const dayCtx = document.getElementById('dayChart');
        if (dayCtx) {
            new Chart(dayCtx, {
                type: 'line',
                data: {
                    labels: {{ day_labels|tojson }},
                    datasets: [{
                        label: 'Spending (‚Ç¨)',
                        data: {{ day_values|tojson }},
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: '#a855f7',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 4. Transaction Frequency (Bar Chart)
        const freqCtx = document.getElementById('frequencyChart');
        if (freqCtx) {
            new Chart(freqCtx, {
                type: 'bar',
                data: {
                    labels: {{ day_labels|tojson }},
                    datasets: [{
                        label: 'Number of Transactions',
                        data: {{ day_transaction_counts|tojson }},
                        backgroundColor: [
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(168, 85, 247, 0.7)',
                            'rgba(168, 85, 247, 0.6)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(168, 85, 247, 0.7)',
                            'rgba(168, 85, 247, 0.5)',
                            'rgba(168, 85, 247, 0.4)'
                        ],
                        borderColor: '#a855f7',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // 5. Monthly Trend (Line Chart)
        const trendCtx = document.getElementById('trendChart');
        if (trendCtx) {
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: {{ month_labels|tojson }},
                    datasets: [
                        {
                            label: 'Income',
                            data: {{ income_trend|tojson }},
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Expenses',
                            data: {{ expense_trend|tojson }},
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: '#ef4444',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 6. Spending Throughout Month (Area Chart)
        const dateCtx = document.getElementById('dateChart');
        if (dateCtx) {
            new Chart(dateCtx, {
                type: 'line',
                data: {
                    labels: {{ date_labels|tojson }},
                    datasets: [{
                        label: 'Daily Spending (‚Ç¨)',
                        data: {{ date_values|tojson }},
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.15)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#f59e0b',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
